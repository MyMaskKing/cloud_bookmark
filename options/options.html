<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>云端书签 - 设置</title>
  <link rel="stylesheet" href="options.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>云端书签设置</h1>
    </header>

    <main class="main">
      <section class="section">
        <h2>WebDAV配置</h2>
        <form id="configForm" class="form">
          <div class="form-group">
            <label for="serverUrl">服务器地址</label>
            <input type="url" id="serverUrl" placeholder="https://example.com/webdav" required>
            <small>请输入完整的WebDAV服务器地址</small>
          </div>

          <div class="form-group">
            <label for="username">用户名</label>
            <input type="text" id="username" placeholder="your-username" required>
          </div>

          <div class="form-group">
            <label for="password">密码</label>
            <input type="password" id="password" placeholder="your-password" required>
          </div>

          <div class="form-group">
            <label for="path">同步路径</label>
            <input type="text" id="path" placeholder="/bookmarks/" value="/bookmarks/">
            <small>书签文件存储路径，默认为 /bookmarks/</small>
          </div>

          <div class="form-group">
            <label for="syncInterval">同步间隔（分钟）</label>
            <input type="number" id="syncInterval" min="1" value="5" required>
            <small>云端到本地的自动同步间隔，默认5分钟</small>
          </div>

          <div class="form-actions">
            <button type="button" id="testBtn" class="btn btn-secondary">测试连接</button>
            <button type="button" id="exportConfigBtn" class="btn btn-secondary">导出配置</button>
            <button type="button" id="importConfigBtn" class="btn btn-secondary">导入配置</button>
            <button type="submit" class="btn btn-primary">保存配置</button>
          </div>
        </form>
      </section>

      <section class="section">
        <h2>同步状态</h2>
        <div id="syncStatus" class="sync-status">
          <div class="status-item">
            <span class="label">状态:</span>
            <span id="statusText" class="value">-</span>
          </div>
          <div class="status-item">
            <span class="label">最后同步:</span>
            <span id="lastSync" class="value">-</span>
          </div>
          <div class="status-item" id="errorItem" style="display: none;">
            <span class="label">错误:</span>
            <span id="errorText" class="value error">-</span>
          </div>
          <div class="status-actions">
            <button id="syncNowBtn" class="btn btn-primary">立即同步</button>
            <button id="syncUploadBtn" class="btn btn-secondary">立即上传</button>
          </div>
        </div>
      </section>

      <section class="section">
        <h2>数据管理</h2>
        <div class="data-actions">
          <button id="exportJsonBtn" class="btn btn-secondary">导出JSON</button>
          <button id="exportHtmlBtn" class="btn btn-secondary">导出HTML</button>
          <button id="importBtn" class="btn btn-secondary">导入书签</button>
          <button id="importBrowserBtn" class="btn btn-secondary">从浏览器导入</button>
          <button id="checkInvalidUrlsBtn" class="btn btn-secondary">一键检测失效网站</button>
          <input type="file" id="importFile" accept=".json,.html" style="display: none;">
        </div>
      </section>

      <section class="section">
        <h2>场景管理</h2>
        <div class="scene-header">
          <div>当前场景：<span id="currentSceneName">-</span></div>
          <button id="addSceneBtn" class="btn btn-primary">添加场景</button>
        </div>
        <div id="sceneList" class="scene-list">
          <div class="empty-state">加载中...</div>
        </div>
        <small>提示：不同场景的书签完全隔离，每个场景的书签存储在独立的文件中（{sceneId}_bookmarks.json）。</small>
      </section>

      <section class="section">
        <h2>界面设置</h2>
        <div class="form-group checkbox-row">
          <label>
            <input type="checkbox" id="expandFirstLevel">
            弹窗默认展开第一层文件夹
          </label>
          <small>关闭后首次打开弹窗不自动展开；仍会记忆你手动的展开/折叠状态（本地保存，不同步云端）。</small>
        </div>
        <div class="form-group checkbox-row">
          <label>
            <input type="checkbox" id="rememberScrollPosition">
            滚动条位置记忆
          </label>
          <small>开启后，弹窗和悬浮球打开的弹窗会记住上次的滚动位置，下次打开时自动恢复。</small>
        </div>
        <div class="form-group checkbox-row">
          <label>
            <input type="checkbox" id="enableFloatingBall">
            开启悬浮球
          </label>
          <small>开启后，在浏览器所有页面显示悬浮球，点击可快速打开书签弹窗。悬浮球位置本地保存，不同步云端。</small>
        </div>
        <div class="form-group" id="floatingBallPositionGroup" style="display: none;">
          <label for="floatingBallDefaultPosition">悬浮球默认位置</label>
          <select id="floatingBallDefaultPosition">
            <option value="auto">自动</option>
            <option value="left">靠左</option>
            <option value="right">靠右</option>
          </select>
          <small>选择悬浮球的默认位置。选择"自动"时，悬浮球会根据位置自动靠到最近的边缘；选择"靠左"或"靠右"时，悬浮球会在2秒后自动靠到指定边缘。</small>
        </div>
        <div class="form-group" id="floatingBallActionGroup" style="display: none;">
          <label for="floatingBallClickAction">悬浮球点击行为</label>
          <select id="floatingBallClickAction">
            <option value="popup">打开弹窗（默认）</option>
            <option value="quickSave">一键保存当前页面</option>
          </select>
          <small>选择点击悬浮球时的行为。默认打开弹窗；一键保存会直接把当前页面加入当前场景书签。</small>
        </div>
        <div class="form-group">
          <label>保存书签快捷键</label>
          <div id="shortcutDisplayWin" style="font-weight:600;">Windows / Linux：加载中…</div>
          <div id="shortcutDisplayMac" style="font-weight:600;">macOS：加载中…</div>
          <small>Firefox 请在 “about:addons → 管理扩展快捷键” 中确认/修改；如有冲突可在此页面重设。</small>
        </div>
        <div class="form-group checkbox-row">
          <label>
            <input type="checkbox" id="enableSyncErrorNotification">
            开启同步失败通知
          </label>
          <small>开启后，同步失败时会弹出提示框（2秒自动消失）。相同错误5分钟内只提示一次，避免通知过于频繁。</small>
        </div>
        <div class="form-group checkbox-row">
          <label>
            <input type="checkbox" id="stickySyncErrorToast">
            调试：同步失败提示不自动消失
          </label>
          <small>仅用于调试：开启后 toast 不会自动消失（直到下次提示覆盖）。不建议长期开启。</small>
        </div>
      </section>

      <section class="section">
        <h2>存储设备管理</h2>
        <div class="device-header">
          <div>
            <div>当前设备：<span id="currentDeviceName">-</span></div>
            <div style="margin-top: 4px; font-size: 12px; color: #666;">设备ID：<span id="currentDeviceId">-</span></div>
          </div>
          <div class="device-actions">
            <button id="refreshDevicesBtn" class="btn btn-secondary">刷新</button>
          </div>
        </div>
        <div class="form-group checkbox-row" style="margin-bottom: 16px;">
          <label>
            <input type="checkbox" id="enableDeviceDetection">
            开启设备检测
          </label>
          <small>关闭后不进行设备检测，但设备列表仍会显示。</small>
        </div>
        <div id="deviceList" class="device-list">
          <div class="empty-state">暂无设备</div>
        </div>
        <small>提示：移除未知设备后，如果本机未在设备列表中，下一次同步将清空本地数据并停止同步。</small>
      </section>
    </main>
  </div>

  <!-- 场景选择对话框 -->
  <div id="sceneSelectModal" class="scene-select-modal" style="display: none;">
    <div class="scene-select-dialog">
      <div class="scene-select-header">
        <h3>选择导入场景</h3>
        <button class="scene-select-close" id="sceneSelectClose">&times;</button>
      </div>
      <div class="scene-select-body">
        <p class="scene-select-hint">请选择要导入书签的场景：</p>
        <div id="sceneSelectList" class="scene-select-list">
          <!-- 场景列表将动态生成 -->
        </div>
      </div>
      <div class="scene-select-footer">
        <button id="sceneSelectCancel" class="btn btn-secondary">取消</button>
        <button id="sceneSelectConfirm" class="btn btn-primary">确定</button>
      </div>
    </div>
  </div>

  <script src="../utils/storage.js"></script>
  <script src="../utils/webdav.js"></script>
  <script src="../utils/utils.js"></script>
  <script src="../utils/bookmarkParser.js"></script>
  <script src="options.js"></script>
</body>
</html>

