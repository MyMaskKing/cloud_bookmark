# 云端书签插件使用说明

> 本文档面向普通用户，介绍如何安装、配置和使用「云端书签」浏览器扩展。插件当前已实现的大部分核心功能，并预留了部分高级能力（如多场景管理、设备检测、悬浮球等）。

---

## 1. 功能概览

- **云端同步**：通过 WebDAV 将书签与自建云盘（如坚果云、Nextcloud、ownCloud 等）双向同步，实现跨设备共享。
- **离线可用**：所有书签首先保存在浏览器本地，没有网络也可以正常查看和管理，网络恢复后自动同步。
- **书签管理**：支持添加、编辑、删除书签，支持备注、标签、多级文件夹和收藏星标。
- **多场景（家庭/工作等）**：内置「家庭」「公司」两个默认场景，并支持自定义场景，不同场景的书签完全隔离（如：工作/学习/个人）。
- **导入导出**：支持浏览器标准 HTML 书签文件导入/导出，以及 JSON 备份；支持直接从浏览器书签栏导入。
- **设备管理与检测**：记录各个使用该插件的设备，可选择是否开启「设备检测」，用于判定是否有其他设备长时间未在线。
- **界面自定义**：支持书签卡片视图/列表视图切换、显示内容开关（URL、描述、备注、标签等）、弹窗默认展开文件夹等。
- **悬浮球入口（可选）**：可在网页右侧显示一个可拖动的悬浮球，点击即可打开插件弹窗。

---

## 2. 安装与加载

### 2.1 Chrome / Edge

1. 将本项目代码克隆或解压到本地（任意目录）。
2. 打开浏览器地址栏输入 `chrome://extensions/`（Edge 为 `edge://extensions/`）。
3. 在右上角开启 **「开发者模式」**。
4. 点击 **「加载已解压的扩展程序」**。
5. 选择项目根目录 `cloud_bookmark`。
6. 安装成功后，工具栏会出现「云端书签」图标。

> 如果使用 `.crx` 安装失败，建议直接采用「加载已解压扩展」的方式进行本地开发和使用。

### 2.2 Firefox（桌面）

1. 打开 `about:debugging#/runtime/this-firefox`。
2. 点击 **「临时载入附加组件」**。
3. 选择项目根目录下的 `manifest.json`。
4. 安装后，工具栏同样会出现插件图标。

> 临时扩展在浏览器重启后会失效，发布正式版本时建议按 Firefox 打包流程生成 `.xpi`。

---

## 3. 首次配置 WebDAV 同步

首次使用前，请先完成 WebDAV 设置。所有设置在 `options.html` 对应的「设置页面」中操作。

### 3.1 打开设置页面

有两种方式进入设置：

- **方式一**：点击浏览器工具栏中的插件图标，在弹出的窗口中点击右上角的 **「设置」** 图标。
- **方式二**：在扩展管理页面中找到「云端书签」，点击 **「扩展选项」**（或「选项」）。

### 3.2 填写 WebDAV 配置信息

在「云端同步配置」区域，按以下字段填写：

- **WebDAV 地址** `serverUrl`
  - 例如：`https://example.com/remote.php/dav/files/username/`、`https://dav.jianguoyun.com/dav/` 等。
- **用户名** `username`
- **密码 / Token** `password`
- **同步路径** `path`
  - 默认值：`/bookmarks/`
  - 插件会在该路径下自动创建目录和文件，例如：`/bookmarks/settings.json`、`/bookmarks/home_bookmarks.json`。
- **同步间隔（分钟）** `syncInterval`
  - 默认 `5` 分钟，用于后台定时自动同步。

### 3.3 测试并保存配置

1. 填写完以上信息后，点击 **「测试连接」** 按钮。
   - 成功时会提示「连接成功」。
   - 如果提示认证失败，请检查地址、账号和密码是否正确，以及服务是否开启 HTTPS / WebDAV。
2. 测试通过后，点击 **「保存配置」**：
   - 插件会再次校验配置并保存到浏览器本地安全存储。
   - 清空旧的同步场景缓存，确保后续所有场景重新与云端对齐。
   - 自动执行：
     - 从云端拉取 `settings.json`（包含场景列表、设备信息等）。
     - 为当前浏览器注册一个唯一设备 ID。
     - 对当前场景执行一次初始同步（云端 → 本地），并将结果显示在界面中。

### 3.4 WebDAV 配置一键导出 / 导入

在「WebDAV 配置工具」区域：

- **导出配置到剪贴板**
  - 点击「导出到剪贴板」，会按如下三行格式复制当前配置：
    ```
    webdav地址
    webdav用户
    webdav密码
    ```
  - 可直接粘贴到其他设备的插件中使用。

- **导入配置**
  - 点击「导入配置」，会弹出输入框。
  - 将上面三行格式的配置粘贴进去，依次为：地址、用户名、密码。
  - 点击「导入」，配置信息会被填回 WebDAV 表单中，确认无误后再点击「保存配置」。

---

## 4. 场景（家庭/工作等）管理与切换

插件支持「场景」概念，用于将不同用途的书签隔离管理，例如家庭 / 公司 / 学习 / 项目 A 等。

### 4.1 场景基础概念

- **默认场景**：
  - `home`：家庭
  - `work`：公司
  - 默认场景不可删除，避免误操作导致主数据丢失。
- **自定义场景**：
  - 用户可自定义新增多个场景，如 `study`、`project_a` 等。
  - 每个场景拥有独立的书签、文件夹、标签集合。
- **数据隔离**：
  - 不同场景的书签、文件夹、标签、搜索、筛选互相独立互不影响。

### 4.2 在设置页管理场景

打开设置页的「场景管理」区域，可进行如下操作：

- **查看当前场景**：顶部会显示当前选中的场景名称和 ID。
- **新增场景**：
  1. 点击「添加场景」。
  2. 在弹出对话框中填写：
     - 场景名称（例如：学习）
     - 场景 ID（仅字母/数字/下划线，如 `study`、`work_01`）。
  3. 确认后保存，插件会在本地和云端 `settings.json` 中新增该场景，并在 WebDAV 上为其创建 `sceneId_bookmarks.json` 文件。
- **重命名场景**：
  - 非默认场景可点击「重命名」，更改显示名称（ID 不变）。
- **删除场景**：
  - 仅自定义场景可以删除。
  - 删除时会出现两次确认提示，确认后会：
    - 从场景列表中移除该场景。
    - 删除本地该场景下的所有书签数据。
    - 请求后台删除云端对应的 `sceneId_bookmarks.json` 文件。
- **切换场景**：
  - 点击某个场景右侧的「切换」按钮，立即切换当前场景。
  - 首次切换到某个场景时，如果云端存在数据，会自动拉取并本地化；
    如果云端没有对应文件，会创建一个空文件，以便后续同步。

> 场景列表和当前选中场景会同时保存到本地和云端，保证跨设备场景一致性。

### 4.3 在弹窗 / 完整界面切换场景

- **弹窗界面（popup）**：
  - 弹窗顶部会显示当前场景名称，点击场景按钮会出现场景列表下拉菜单。
  - 选择任意场景后，列表中展示的书签即切换为该场景的数据。

- **书签管理完整界面（`pages/bookmarks.html`）**：
  - 顶部导航栏同样提供场景切换按钮和下拉菜单。
  - 切换后，左侧文件夹树、标签列表、主列表中的内容都会切换为对应场景的数据。

---

## 5. 设备管理与设备检测

### 5.1 设备列表

在设置页的「设备管理」区域，可以看到：

- **当前设备信息**：
  - 显示当前浏览器实例的设备名称和 **设备 ID**。
  - 设备 ID 规则大致为：`浏览器类型_设备类型_随机唯一串`，例如：
    - `chrome_PC_xxxxx`、`firefox_android_xxxxx`、`unknownbrowser_unknowndevice_xxxxx`。
- **其他已注册设备**：
  - 每个设备会显示：设备名称、设备 ID、创建时间、上次在线时间。
- **移除设备**：
  - 点击某设备右侧的「移除」按钮即可将其从列表中删除。
  - 如果删除的是当前设备，会提示删除后本机可能会清空本地数据并停止同步，需要再次确认。

### 5.2 设备检测开关

- 在设置页勾选或取消 **「开启设备检测」**：
  - 默认关闭。
  - 变更开关后会立即将设置同步到云端。
  - 后台逻辑可基于设备 ID 和上次在线时间进行「异常设备检测」或提醒（视后续版本实现）。

---

## 6. 悬浮球入口（可选）

悬浮球用于在任意页面右侧显示一个可拖动的小圆形按钮，点击后直接打开插件弹窗。

### 6.1 开启 / 关闭悬浮球

1. 在设置页找到「悬浮球」相关设置，勾选或取消 **「开启悬浮球」**。
2. 状态变更后会：
   - 立即保存到本地设置中。
   - 同步到云端 `settings.json`。
   - 通过消息通知所有打开的标签页更新悬浮球显示（显示或隐藏）。

### 6.2 在页面中使用悬浮球

- 开启后，浏览器右侧会出现一个可以拖动的小圆点：
  - **单击**：打开云端书签的弹窗界面（与工具栏图标点击效果相同）。
  - **拖动**：按住鼠标左键可在垂直方向任意拖动，调整悬浮球垂直位置。

> 悬浮球实现位于 `content/floating-ball.js`，原理是通过内容脚本在页面中插入一个固定定位的按钮，并与 background/popup 通信。

---

## 7. 日常使用：添加与管理书签

### 7.1 快速添加当前页面书签

在浏览器中浏览网页时，可以通过以下方式快速收藏当前页面：

- **方式一：插件弹窗**
  1. 点击浏览器工具栏的「云端书签」图标。
  2. 在弹窗中点击 **「添加当前页面」** 按钮。
  3. 插件会打开完整管理页面，并自动填充当前页面的标题和 URL。

- **方式二：快捷键**
  - 在支持的浏览器中，可使用快捷键 `Ctrl+Shift+B`（macOS 为 `Command+Shift+B`）触发添加逻辑（具体以 manifest 配置为准）。

- **方式三：右键菜单**
  - 在页面空白处或链接上点击右键，选择「添加到云端书签」（依赖浏览器 contextMenus 权限）。

### 7.2 在完整界面添加书签

1. 打开完整管理界面：
   - 从弹窗中点击「进入完整界面」，或
   - 在地址栏输入 `chrome-extension://…/pages/bookmarks.html`（系统自动生成）。
2. 点击页面顶部或空状态中的 **「添加书签」** 按钮。
3. 填写以下字段：
   - **标题**：默认留空或由当前页自动填充，可手动修改。
   - **URL**：书签链接，必须是合法 URL。
   - **描述**（可选）：对书签的简短说明。
   - **备注/笔记**（可选）：支持多行文本，可详细记录步骤、账号信息提示等。
   - **标签**（可选）：逗号分隔，如 `前端, React, 教程`。
   - **文件夹**（可选）：从已有文件夹中选择，或保持「未分类」。
   - **收藏（星标）**：勾选后该书签会被标记为重要项目，在筛选/排序中优先显示。
4. 点击「保存」，即可将书签保存到当前场景，并自动：
   - 更新本地存储。
   - 触发同步（当前场景 → 云端）。

### 7.3 编辑 / 删除书签

- 在书签卡片右上角使用：
  - **铅笔图标**：编辑书签，进入和添加类似的表单界面。
  - **垃圾桶图标**：删除书签，删除前会弹出确认提示。
- 修改或删除后，同步逻辑与新增相同，会实时更新到云端对应场景文件。

### 7.4 收藏（星标）

- 书签卡片右上角有星标图标：
  - **点击空星（☆）**：设为收藏（⭐）。
  - **再次点击**：取消收藏。
- 在过滤栏中选择「收藏」可仅查看已星标的书签。
- 在排序中选择「收藏优先」可让星标书签排在前面。

### 7.5 文件夹管理

在完整界面左侧的「文件夹」区域可以：

- **查看文件夹树**：
  - 支持多级目录，例如 `项目/前端/UI`。
  - 点击文件夹名称可筛选该文件夹下的书签。
- **新增文件夹**：
  - 点击「新增文件夹」，输入路径，如 `项目/后端`；插件会自动创建多级结构。
- **重命名/移动文件夹**：
  - 点击文件夹行右侧的「…」菜单，选择「重命名/移动」，可同时修改父级路径。
- **删除文件夹（含子文件夹书签）**：
  - 在「…」菜单中选择「删除」，将删除该目录及所有子目录下的书签，请谨慎操作。
- **拖拽排序 & 同级上移/下移**：
  - 支持在同一层级内拖动重新排序或通过菜单按钮调整顺序，排序结果也会同步到云端。
- **未分类书签入口**：
  - 如果当前场景存在未指定文件夹的书签，会在列表顶部显示一个「未分类」虚拟文件夹入口。

### 7.6 标签管理

在左侧「标签」区域：

- 显示当前场景中所有使用过的标签（自动汇总）。
- 点击某个标签，即可过滤只展示带有此标签的书签。

### 7.7 搜索与筛选

- **搜索框**：支持在标题、URL、描述、备注、标签中搜索关键字。
- **顶部筛选导航**：提供「全部书签」「收藏」「最近添加」等快捷入口。
- **排序**：
  - 按创建时间（最新在前 / 最早在前）。
  - 按标题（A→Z / Z→A）。
  - 按收藏状态（收藏在前）。

### 7.8 视图和显示选项

- 在书签界面右上角：
  - **视图切换按钮**：
    - 列表视图：每行展示更多文本信息，适合阅读备注。
    - 网格视图：卡片布局，适合图文并重展示。
  - **显示选项**：点击「显示选项」按钮可选择是否显示：
    - 网站图标
    - URL
    - 描述
    - 备注
    - 标签
- 所有视图设置都会保存在本地设置中，并同步到云端，保证多设备一致。

### 7.9 批量操作与批量移动

在完整管理界面，支持对书签进行批量移动：

1. 点击顶部的「批量操作」按钮，进入批量模式：
   - 每个书签卡片左侧会出现复选框。
2. 勾选需要移动的书签，可以使用「全选/取消全选」按钮辅助操作。
3. 点击底部批量操作栏中的「批量移动」：
   - 弹出文件夹选择对话框，可选择目标文件夹或「未分类」。
4. 确认后，选中的书签会统一移动到目标文件夹，并自动同步到云端当前场景文件。
5. 批量操作完成后，点击「退出批量模式」回到正常视图。

---

## 8. 导入 / 导出与备份

### 8.1 从浏览器书签栏导入

在设置页的「导入导出」区域：

1. 点击「从浏览器书签栏导入」。
2. 选择导入目标场景（如：家庭 / 公司 / 学习）。
3. 插件会：
   - 通过浏览器书签 API 读取当前浏览器的书签栏结构。
   - 将每个书签转换为插件内部格式，并自动规范化文件夹路径。
   - 同一场景内如已存在相同 URL，将跳过重复项。
4. 完成后会提示「导入成功，新增 X 个书签到“某某场景”」。

> 某些移动浏览器可能不支持书签 API，此时会提示不支持，请改用 HTML 文件方式导入。

### 8.2 从文件导入（JSON / HTML）

1. 在设置页点击「从文件导入」，选择 `.json` 或 `.html` 文件：
   - `.json`：为插件导出的原始数据格式。
   - `.html`：为浏览器标准书签导出格式。
2. 选择导入目标场景。
3. 插件会解析文件中的书签和文件夹，并：
   - 规范化文件夹路径（去除多余斜杠等）。
   - 在同一场景内按 URL 去重。
   - 仅保留被实际使用的文件夹，自动清理空文件夹。
4. 导入成功后，同样会立即把该场景的新数据同步到云端。

### 8.3 导出为 JSON / HTML

#### 8.3.1 在设置页导出

- 「导出为 JSON」：
  - 仅导出当前场景的书签与文件夹到 `.json` 文件，可用作完整备份或跨设备恢复。
- 「导出为 HTML」：
  - 仅导出当前场景数据为浏览器兼容的书签 HTML 文件，可直接导入 Chrome/Firefox 的书签管理器。

#### 8.3.2 在完整界面导出

- 书签管理界面右上角「导出」按钮：
  - 弹出菜单可选择「导出为 JSON」或「导出为 HTML」。
  - 行为与设置页一致，同样只导出当前场景的数据。

### 8.4 同步策略与本地归档（与需求对齐）

- **云端 → 本地**：
  - 插件启动、场景首次切换、手动点「同步」时会从 WebDAV 拉取对应场景文件，并与本地数据合并。
- **本地 → 云端**：
  - 添加/修改/删除书签、一部分设置变更或导入数据后，会立即触发上传当前场景数据到云端。
- **本地已有书签的归档策略**（需求中约定）：
  - 当 WebDAV 设置保存后首次同步，如果检测到本地已有书签，插件应：
    - 先将本地旧书签归档到本地备用目录（避免被覆盖）。
    - 在云端数据的基础上合并本地归档目录中的书签，再上传。
  - 这一逻辑在当前版本中已通过本地统一存储与增量合并的方式部分实现，后续版本可进一步强化可视化的「归档」与「还原」入口。

---

## 9. 同步状态与手动同步

### 9.1 查看同步状态

- 在设置页顶部可看到：
  - **状态**：空闲 / 同步中 / 成功 / 错误。
  - **最后同步时间**。
  - 如发生错误（网络异常、认证失败等），会在错误区域显示详细信息。

- 在弹窗界面，左下角有一个小圆点和文字：
  - 绿色：已同步。
  - 黄色：同步中。
  - 红色：同步失败。

### 9.2 手动同步

- 设置页中的「立即同步」按钮：
  - 主动触发一次云端 ↔ 本地双向同步，适合网络恢复或刚修改 WebDAV 设置时使用。

- 完整界面右上角的「同步」图标：
  - 手动拉取云端最新数据，并刷新当前场景书签列表。

- 设置页中的「仅上传」按钮：
  - 只将当前本地变化上传到云端，而不从云端拉取（适合确认本地为最新数据时使用）。

---

## 10. 调试与问题排查

### 10.1 导出调试日志

弹窗界面右上角提供「导出日志」按钮，用于快速收集排查信息（不会导出密码等敏感字段）：

- 日志内容包括：
  - 插件版本与 manifest 版本。
  - 浏览器 UA / 平台 / 语言 / 时区。
  - 当前同步状态。
  - 待同步变更列表。
  - 当前闹钟任务（定时同步）。
  - 近期书签摘要和部分书签数据（仅用于结构排查）。
  - 设备列表与当前设备信息。
  - 非敏感设置和掩码处理后的 WebDAV 配置（密码等字段会被替换为 `***`）。
  - 运行时异常与控制台日志。

遇到问题时可将该日志文件附在 Issue 中，方便定位。

### 10.2 常见问题

- **提示「无法连接到 WebDAV 服务器」**：
  - 检查地址是否正确（包含完整路径，如 `.../dav/`）。
  - 确保服务端启用了 WebDAV 并支持 HTTPS。
  - 确认账号、密码或应用专用密码/Token 是否正确。
- **同步后发现书签丢失或不完整**：
  - 检查当前是否处于正确的「场景」中（例如家庭/公司）。
  - 确认 WebDAV 路径下是否有多个 `*_bookmarks.json` 文件。
  - 建议先通过 JSON 导出当前本地数据备份，再进行进一步操作。
- **移动端无法使用悬浮球或弹窗异常**：
  - 不同浏览器的移动版对扩展支持差异较大，建议优先使用桌面浏览器配置和管理，再在支持的移动浏览器中查看。

---

## 11. 安全与隐私

- 所有书签与设置仅存储在：
  - 浏览器本地（`chrome.storage.local` / `browser.storage.local`）。
  - 用户自行配置的 WebDAV 服务器（`settings.json` 与各 `sceneId_bookmarks.json` 文件）。
- 插件**不会上传任何数据到作者或第三方服务器**。
- WebDAV 密码会存储在浏览器提供的存储空间中，敏感字段在日志和导出中均会被掩码处理。

---

## 12. 建议的使用场景示例

- **场景区分工作与生活**：
  - 在「家庭」场景中整理娱乐、购物、生活类书签。
  - 在「公司」或「项目」场景中整理开发文档、需求、项目 Wiki 等。
- **多设备协同**：
  - 在 PC 上主要维护书签结构和备注。
  - 在手机浏览器上只需安装插件并导入同样的 WebDAV 配置，即可共享同一套云端书签。
- **备份与迁移**：
  - 定期导出 JSON 文件保存在本地或云盘，以防 WebDAV 配置变更或误操作。
  - 从其他在线书签服务或浏览器导出 HTML 文件，再导入到指定场景，实现一次性迁移。

---

如在使用过程中遇到任何问题或有功能建议，欢迎在仓库中提交 Issue 或 Pull Request，一起打磨更好用的云端书签工具。