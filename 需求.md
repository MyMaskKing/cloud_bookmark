# 云端书签浏览器插件需求文档

## 1. 项目概述

### 1.1 项目目标
开发一个跨平台的云端书签管理浏览器插件，使用WebDAV协议进行数据同步，实现书签的云端存储和跨设备同步功能。

### 1.2 对标对象
- raindrop.io（参考其UI/UX设计和功能体验）

### 1.3 适配平台
- **PC浏览器**：
  - Google Chrome（Windows/macOS/Linux）
  - Mozilla Firefox（Windows/macOS/Linux）
- **移动端浏览器**：
  - Google Chrome（Android）
  - Mozilla Firefox（Android）
- **平台适配要求**：
  - 确保PC端和移动端功能一致性
  - 移动端优化触摸操作体验
  - 响应式布局适配不同屏幕尺寸

---

## 2. 核心功能需求

### 2.1 数据同步功能

#### 2.1.1 云端到本地同步
- **同步方式**：定时自动同步
- **同步间隔**：用户可自定义设置，默认5分钟
- **同步触发**：
  - 定时自动同步
  - 手动触发同步（用户点击同步按钮）
  - 插件启动时自动同步一次
- **同步策略**：增量同步，仅同步变更内容
- **冲突处理**：当本地和云端都有修改时，采用时间戳优先策略（最新修改优先），或提供用户选择
- **离线模式支持**：书签展示完全基于本地存储的数据，即使离线也能正常查看和管理书签

#### 2.1.2 本地到云端同步
- **同步方式**：实时同步（仅在本地数据变更时触发）
- **同步触发时机**：
  - 添加书签后立即同步
  - 修改书签后立即同步
  - 删除书签后立即同步
- **同步策略**：
  - 书签展示完全基于本地存储的数据
  - 只有本地书签发生变更（增加/修改/删除）时，才会将变更同步到云端
  - 离线时，本地变更会暂存在本地，待网络恢复后自动同步
- **同步状态提示**：显示同步中/同步成功/同步失败状态
- **失败重试**：同步失败时自动重试（最多3次），失败后提示用户，并将变更记录在本地待同步队列中

#### 2.1.3 WebDAV配置
- **配置项**：
  - WebDAV服务器地址（URL）
  - 用户名
  - 密码/Token
  - 同步路径（可选，默认：/bookmarks/）
- **连接测试**：配置后提供测试连接功能
- **安全存储**：密码使用浏览器安全存储API加密保存
- **文件存储规则**：
  - **设置文件**：统一存储在 `settings.json`（固定文件名，包含场景列表、设备信息等）
  - **书签文件**：不同场景的书签存储在不同的文件中
    - 文件命名规则：`{sceneId}_bookmarks.json`
    - 例如：`home_bookmarks.json`（家庭场景）、`work_bookmarks.json`（公司场景）
    - 场景ID（sceneId）使用场景的唯一标识符（如：home、work等）
  - **同步策略**：
    - 切换场景时，只同步当前场景对应的书签文件
    - 设置文件在所有场景间共享，统一同步
    - 添加/删除场景时，自动创建/删除对应的书签文件

### 2.2 数据存储

#### 2.2.1 存储位置
- **云端存储**：WebDAV服务器
  - **设置文件**：`settings.json`（统一存储，所有场景共享）
  - **书签文件**：`{sceneId}_bookmarks.json`（每个场景独立文件）
    - 例如：`home_bookmarks.json`、`work_bookmarks.json`
- **本地存储**：浏览器本地存储（IndexedDB或chrome.storage）
  - **设置数据**：场景列表、当前选中场景、WebDAV配置等
  - **书签数据**：所有场景的书签数据统一存储在本地，通过 `scene` 字段区分

#### 2.2.2 数据格式
- **书签数据结构**：
  ```json
  {
    "id": "唯一标识符",
    "title": "书签标题",
    "url": "书签URL",
    "description": "书签描述（可选）",
    "notes": "书签备注/笔记（可选）",
    "tags": ["标签1", "标签2"],
    "folder": "文件夹路径",
    "icon": "网站图标URL",
    "favicon": "网站favicon URL",
    "starred": false,
    "scene": "场景标识（如：home、work等）",
    "createdAt": "创建时间戳",
    "updatedAt": "更新时间戳"
  }
  ```
- **字段说明**：
  - `notes`: 书签备注/笔记，支持多行文本，用于记录书签相关的重要信息
  - `starred`: 收藏/星标状态，布尔值，true表示已收藏
  - `scene`: 场景标识，用于区分不同场景下的书签（如：home、work等）
- **文件夹结构**：支持多级文件夹嵌套
- **数据文件格式**：
  - **书签文件**：JSON格式存储，文件名为 `{sceneId}_bookmarks.json`
    - 例如：`home_bookmarks.json`、`work_bookmarks.json`
    - 文件内容包含该场景下的所有书签和文件夹信息
  - **设置文件**：JSON格式存储，文件名为 `settings.json`（固定名）
    - 包含场景列表、设备信息、非敏感设置等
- **场景数据结构**：
  ```json
  {
    "scenes": [
      {
        "id": "home",
        "name": "家庭",
        "isDefault": true,
        "createdAt": "创建时间戳",
        "updatedAt": "更新时间戳"
      },
      {
        "id": "work",
        "name": "公司",
        "isDefault": false,
        "createdAt": "创建时间戳",
        "updatedAt": "更新时间戳"
      }
    ],
    "currentScene": "home"
  }
  ```

#### 2.2.3 数据备份
- 本地自动备份最近3次同步的数据
- 支持手动导出备份文件

### 2.3 添加书签功能

#### 2.3.1 添加方式
- **方式一**：直接进入添加书签界面
  - 通过插件图标点击
  - 通过右键菜单"添加到云端书签"
  - 快捷键（如Ctrl+Shift+B）
- **方式二**：从书签一览界面添加
  - 在书签列表界面点击"+"按钮
  - 弹出添加书签表单

#### 2.3.2 添加表单字段
- **必填项**：
  - 标题（自动从当前页面标题获取）
  - URL（自动从当前页面URL获取）
- **可选项**：
  - 描述
  - 备注/笔记（支持多行文本输入）
  - 标签（支持多标签，标签自动补全）
  - 文件夹（支持选择已有文件夹或创建新文件夹）
  - 收藏/星标（快速标记重要书签）
  - 网站图标（自动获取）
  - 场景（自动使用当前选中的场景，不可手动修改）

#### 2.3.3 快速添加
- 当前页面快速添加：自动填充当前页面信息
- 批量导入：支持从浏览器书签栏批量导入

### 2.4 查看和管理书签

#### 2.4.1 书签列表展示
- **视图模式**：
  - 列表视图（默认）
  - 网格视图（卡片式）
  - 紧凑视图
- **排序方式**：
  - 按创建时间（最新/最旧）
  - 按标题（A-Z/Z-A）
  - 按收藏状态（收藏优先）
  - 按文件夹
- **筛选功能**：
  - 按标签筛选
  - 按文件夹筛选
  - 按收藏状态筛选（仅显示收藏的书签）
  - 搜索（标题、URL、描述、备注、标签）
- **分页/虚拟滚动**：支持大量书签的流畅展示

#### 2.4.2 书签操作
- **查看详情**：点击书签查看完整信息（包括备注/笔记）
- **编辑**：修改标题、URL、描述、备注/笔记、标签、文件夹、收藏状态
- **删除**：删除书签（需确认，支持批量删除）
- **收藏/取消收藏**：快速切换书签的星标状态，支持批量操作
- **访问网站**：
  - 默认：新建标签页打开
  - 可选：当前页面打开
  - 右键菜单选择打开方式
- **复制链接**：复制书签URL到剪贴板
- **分享**：生成分享链接（如需要）

#### 2.4.3 文件夹管理
- 创建文件夹
- 重命名文件夹
- 删除文件夹（需确认是否删除文件夹内书签）
- 移动文件夹
- 文件夹嵌套（支持多级）

#### 2.4.4 标签管理
- 查看所有标签
- 标签云展示
- 按标签筛选书签
- 编辑/删除标签

#### 2.4.5 收藏/星标功能
- 快速收藏：一键添加/取消收藏标记
- 收藏视图：单独查看所有收藏的书签
- 收藏筛选：在书签列表中筛选显示收藏的书签
- 批量操作：支持批量收藏/取消收藏

### 2.5 场景切换功能

#### 2.5.1 场景管理
- **默认场景**：
  - 家庭（home）：默认场景，不可删除
  - 公司（work）：默认场景，不可删除
- **场景操作**：
  - 添加场景：用户可以自定义添加新场景（如：学习、项目A、项目B等）
  - 重命名场景：可以重命名自定义场景（默认场景不可重命名）
  - 删除场景：可以删除自定义场景（默认场景不可删除），删除时需确认是否同时删除该场景下的所有书签
  - 设置默认场景：可以设置某个场景为默认场景（启动时自动选中）
- **场景切换**：
  - 单选模式：同一时间只能选择一个场景
  - 切换后立即生效：切换场景后，界面立即显示该场景下的书签
  - 场景状态持久化：当前选中的场景会保存到本地和云端，跨设备同步

#### 2.5.2 场景数据隔离
- **书签隔离**：不同场景下的书签完全隔离，互不影响
- **文件夹隔离**：不同场景下的文件夹完全隔离，互不影响
- **标签隔离**：不同场景下的标签完全隔离，互不影响
- **搜索隔离**：搜索功能仅搜索当前场景下的书签
- **筛选隔离**：所有筛选功能（按标签、按文件夹、按收藏状态）仅作用于当前场景

#### 2.5.3 场景数据存储
- **本地存储**：
  - 场景列表存储在 `chrome.storage.local` 中
  - 当前选中场景存储在 `chrome.storage.local` 中
  - 所有场景的书签数据统一存储在本地，通过 `scene` 字段区分场景
- **云端存储**：
  - **设置文件**（`settings.json`，固定文件名）：
    - 场景列表
    - 当前选中场景
    - 设备信息
    - 非敏感设置
  - **书签文件**（`{sceneId}_bookmarks.json`，按场景分文件）：
    - 每个场景的书签数据存储在独立的文件中
    - 文件命名规则：`{sceneId}_bookmarks.json`
    - 例如：家庭场景 → `home_bookmarks.json`，公司场景 → `work_bookmarks.json`
    - 文件内容包含该场景下的所有书签和文件夹信息
- **数据同步**：
  - **设置文件同步**：
    - 场景列表变更时自动同步 `settings.json`
    - 场景切换时自动同步 `settings.json`（更新当前选中场景）
    - 跨设备同步场景列表和当前选中场景
  - **书签文件同步**：
    - 切换场景时，只同步当前场景对应的书签文件（`{sceneId}_bookmarks.json`）
    - 添加场景时，自动创建对应的书签文件
    - 删除场景时，可选择是否删除对应的书签文件
    - 每个场景的书签变更只影响对应的书签文件

#### 2.5.4 场景切换界面
- **设置页面**：
  - 场景管理区域：显示所有场景列表
  - 场景操作按钮：添加、重命名、删除、设置默认
  - 当前场景标识：高亮显示当前选中的场景
- **弹窗界面**：
  - 场景切换按钮：显示当前场景名称，点击弹出场景选择菜单
  - 场景选择菜单：显示所有场景，单选切换
- **完整界面**：
  - 场景切换按钮：显示在顶部导航栏，显示当前场景名称，点击弹出场景选择菜单
  - 场景选择菜单：显示所有场景，单选切换

### 2.6 导入导出功能

#### 2.6.1 导出功能
- **导出到浏览器**：
  - 支持导出为HTML格式（浏览器标准书签格式）
  - 可选择导出全部或指定文件夹/标签
  - 导出后可直接导入到浏览器书签管理器
- **导出为文件**：
  - JSON格式（完整数据，包含元数据）
  - HTML格式（浏览器兼容格式）

#### 2.6.2 导入功能
- **从浏览器导入**：
  - 支持导入浏览器现有书签（HTML格式）
  - 导入时自动解析文件夹结构
  - **导入时场景选择**：导入前弹出场景选择对话框，用户可选择导入到哪个场景（家庭/公司/自定义场景）
  - 导入后自动同步到云端
- **从文件导入**：
  - 支持JSON格式导入
  - 支持HTML格式导入
  - **导入时场景选择**：导入前弹出场景选择对话框，用户可选择导入到哪个场景（家庭/公司/自定义场景）
  - 导入时提供预览和选择功能
- **导入策略**：
  - 合并模式：合并到现有书签（仅合并到选中的场景）
  - 替换模式：替换现有书签（仅替换选中场景的书签）
  - 跳过重复：自动检测重复书签（在同一场景内检测）

---

## 3. 用户界面设计

### 3.1 插件图标和弹出窗口
- **插件图标**：显示同步状态（正常/同步中/错误）
- **弹出窗口**：
  - **场景切换按钮**：显示当前场景名称，点击可切换场景（家庭/公司/自定义场景）
  - 快速搜索框
  - 最近添加的书签（3-5个，仅显示当前场景的书签）
  - 快速添加当前页面按钮（添加到当前场景）
  - 进入完整界面按钮

### 3.2 完整界面设计
- **顶部导航栏**：
  - **场景切换按钮**：显示当前场景名称，点击可切换场景（家庭/公司/自定义场景）
  - 搜索框（仅搜索当前场景的书签）
  - 视图切换按钮
  - 排序/筛选按钮
  - 设置按钮
- **侧边栏**：
  - 文件夹树形结构（仅显示当前场景的文件夹）
  - 标签列表（仅显示当前场景的标签）
  - 全部书签/未分类（仅显示当前场景的书签）
- **主内容区**：
  - 书签列表/网格展示（仅显示当前场景的书签）
  - 空状态提示
- **底部状态栏**：
  - 书签总数（当前场景的书签数量）
  - 同步状态
  - 最后同步时间

### 3.3 响应式设计
- PC端：充分利用屏幕空间，多列布局
- 移动端：单列布局，触摸友好，支持手势操作

### 3.4 主题支持
- 浅色主题（默认）
- 深色主题
- 跟随系统主题

### 3.5 UI设计风格
- **设计参考**：raindrop.io
- **设计原则**：
  - 简洁现代的界面设计
  - 流畅的交互动画
  - 直观的操作体验
  - 美观的卡片式布局
  - 清晰的视觉层次

---

## 4. 技术架构

### 4.1 技术栈
- **前端框架**：原生JavaScript或轻量级框架（考虑插件体积）
- **存储**：
  - 本地：IndexedDB（Chrome）或browser.storage（Firefox）
  - 云端：WebDAV协议
- **WebDAV客户端**：使用fetch API或WebDAV库
- **构建工具**：Webpack/Vite（用于打包）

### 4.2 浏览器API使用
- `chrome.bookmarks` / `browser.bookmarks`：浏览器书签API（用于导入导出）
- `chrome.storage` / `browser.storage`：本地存储
- `chrome.tabs` / `browser.tabs`：标签页操作
- `chrome.contextMenus` / `browser.contextMenus`：右键菜单
- `chrome.alarms` / `browser.alarms`：定时任务（同步）

### 4.3 文件结构
```
cloud_bookmark/
├── manifest.json          # 插件配置文件
├── background/            # 后台脚本
│   ├── background.js     # 主后台脚本
│   └── sync.js          # 同步逻辑
├── content/              # 内容脚本（如需要）
├── popup/                # 弹出窗口
│   ├── popup.html
│   ├── popup.js
│   └── popup.css
├── options/              # 设置页面
│   ├── options.html
│   ├── options.js
│   └── options.css
├── pages/                # 完整界面页面
│   ├── bookmarks.html
│   ├── bookmarks.js
│   └── bookmarks.css
├── utils/                # 工具函数
│   ├── webdav.js        # WebDAV客户端
│   ├── storage.js       # 存储管理
│   └── utils.js         # 通用工具
└── assets/               # 静态资源
    ├── icons/           # 图标
    └── images/          # 图片
```

---

## 5. 权限要求

### 5.1 必需权限
- `storage`：本地数据存储
- `bookmarks`：读取/写入浏览器书签（导入导出功能）
- `tabs`：获取当前标签页信息（快速添加书签）
- `contextMenus`：右键菜单（快速添加）
- `alarms`：定时同步任务
- `webRequest` 或 `host_permissions`：访问WebDAV服务器

### 5.2 可选权限
- `activeTab`：获取当前活动标签页信息

---

## 6. 错误处理和异常情况

### 6.1 网络错误
- WebDAV连接失败：提示用户检查网络和配置
- 超时处理：设置合理的超时时间（30秒），超时后重试
- 服务器错误：显示具体错误信息

### 6.2 数据错误
- 数据格式错误：验证数据格式，提供修复建议
- 数据冲突：提供冲突解决界面
- 数据损坏：使用备份数据恢复

### 6.3 用户提示
- 同步成功/失败提示
- 操作确认提示（删除等危险操作）
- 错误信息提示（用户友好的错误描述）

---

## 7. 性能要求

### 7.1 性能指标
- 插件启动时间：< 500ms
- 书签列表加载：< 1s（1000条以内）
- 同步操作：< 5s（正常网络环境）
- 搜索响应：< 200ms

### 7.2 优化策略
- 数据分页加载
- 虚拟滚动（大量数据）
- 增量同步
- 本地缓存优先
- 异步操作

---

## 8. 安全要求

### 8.1 数据安全
- WebDAV密码加密存储
- 敏感数据传输使用HTTPS
- 本地数据加密（可选）

### 8.2 隐私保护
- 不收集用户数据
- 所有数据存储在用户指定的WebDAV服务器
- 不向第三方发送数据

---

## 9. 开发计划（建议）

### 9.1 第一阶段：基础功能
- WebDAV连接和配置
- 基础数据存储
- 简单的添加/查看书签功能

### 9.2 第二阶段：核心功能
- 完整的同步机制
- 书签管理功能（编辑、删除、文件夹）
- 导入导出功能

### 9.3 第三阶段：优化和完善
- UI/UX优化
- 性能优化
- 错误处理完善
- 多平台适配

### 9.4 第四阶段：高级功能
- 标签管理
- 搜索优化
- 批量操作
- 主题支持

---

## 10. 测试要求

### 10.1 功能测试
- 所有核心功能测试
- 边界情况测试
- 异常情况测试

### 10.2 兼容性测试
- **浏览器兼容性**：
  - Chrome浏览器测试（PC和Android）
  - Firefox浏览器测试（PC和Android）
- **WebDAV服务器兼容性**：
  - 支持标准WebDAV协议
  - 测试常见WebDAV服务（如Nextcloud、ownCloud、坚果云等）
  - 确保与通用WebDAV服务器兼容

### 10.3 性能测试
- 大量数据测试（10000+书签）
- 网络异常测试
- 并发操作测试

---

## 11. 已确认功能

### 11.1 已确认需求
- ✅ **书签备注/笔记功能**：支持为书签添加备注和笔记，支持多行文本
- ✅ **书签收藏/星标功能**：支持收藏/取消收藏书签，可筛选查看收藏的书签
- ❌ **书签访问统计**：不需要支持访问统计功能
- ✅ **离线模式**：
  - 书签展示完全基于本地存储的数据
  - 只有本地书签发生变更（增加/修改/删除）时，才会同步到云端
  - 离线时本地变更会暂存，待网络恢复后自动同步
- ✅ **WebDAV兼容性**：支持通用的标准WebDAV协议
- ✅ **UI设计风格**：参考raindrop.io的设计风格
- ✅ **平台适配**：适配Chrome和Firefox的PC端和Android端

### 11.2 场景切换功能（待确认）

- [ ] **场景切换功能**：
  - **功能说明**：
    - 支持创建多个场景（默认：家庭、公司），每个场景下的书签完全隔离
    - 可以在弹窗和完整界面中切换场景，切换后只显示当前场景下的书签
    - 场景列表和当前选中场景会同步到云端，实现跨设备同步
    - 导入书签时可以选择导入到哪个场景
  - **使用场景**：
    - 区分工作和个人书签
    - 区分不同项目的书签
    - 区分不同用途的书签（学习、娱乐、工作等）
  - **界面要求**：
    - 设置页面：场景管理（添加、重命名、删除、设置默认）
    - 弹窗界面：场景切换按钮（显示当前场景，点击切换）
    - 完整界面：场景切换按钮（显示当前场景，点击切换）
    - 导入界面：场景选择对话框（选择导入到哪个场景）
  - **数据要求**：
    - 书签数据结构增加 `scene` 字段
    - 场景列表存储在本地和云端（`settings.json`）
    - 当前选中场景存储在本地和云端（`settings.json`）
    - **云端文件存储规则**：
      - 设置文件：`settings.json`（固定文件名，所有场景共享）
      - 书签文件：`{sceneId}_bookmarks.json`（每个场景独立文件）
      - 例如：`home_bookmarks.json`、`work_bookmarks.json`
    - **同步策略**：
      - 切换场景时，只同步当前场景对应的书签文件
      - 设置文件在所有场景间共享，统一同步
  - **确认状态**：待确认

### 11.3 其他待确认事项

- [ ] **多账户切换功能**：
  - 说明：支持在同一个插件中配置多个WebDAV账户，可以切换不同的账户来管理不同的书签集合
  - 使用场景：个人账户和工作账户分离，或管理多个项目的书签
  - 是否需要：待确认
